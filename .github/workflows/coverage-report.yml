name: Coverage Report

on:
  workflow_run:
    workflows: ["Python CI"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: read
  actions: read

jobs:
  coverage-comment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Extract coverage percentage
        id: coverage
        run: |
          # Extract coverage percentage from coverage.xml
          if [ -f coverage.xml ]; then
            # Parse coverage percentage
            COVERAGE=$(python3 -c 'import xml.etree.ElementTree as ET; tree = ET.parse("coverage.xml"); root = tree.getroot(); print(f"{float(root.attrib[\"line-rate\"]) * 100:.1f}")')
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Coverage: $COVERAGE%"
            
            # Generate coverage summary
            echo "## üìä Code Coverage Report" > coverage_comment.md
            echo "" >> coverage_comment.md
            echo "**Total Coverage:** ${COVERAGE}%" >> coverage_comment.md
            echo "" >> coverage_comment.md
            
            # Color code based on coverage
            if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
              echo "‚úÖ Excellent coverage! (‚â•80%)" >> coverage_comment.md
            elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
              echo "‚ö†Ô∏è Moderate coverage (60-80%)" >> coverage_comment.md
            else
              echo "‚ùå Low coverage (<60%)" >> coverage_comment.md
            fi
            
            echo "" >> coverage_comment.md
            echo "_Coverage report generated from unit tests_" >> coverage_comment.md
          else
            echo "‚ö†Ô∏è Coverage file not found" > coverage_comment.md
          fi

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const coverage_comment = fs.readFileSync('coverage_comment.md', 'utf8');
            
            // Get the PR number from the workflow run
            const { data: pr } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.workflow_run.head_sha
            });
            
            if (pr.length > 0) {
              const pr_number = pr[0].number;
              
              // Check if we already commented
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('üìä Code Coverage Report')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: coverage_comment
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr_number,
                  body: coverage_comment
                });
              }
            }


