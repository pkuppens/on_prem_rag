name: Python CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

# Cancel superseded runs on the same branch (e.g., rapid dependabot merges)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# HuggingFace cache lives under ~/.cache/huggingface on the runner.
# Each step that uses models sets these env vars explicitly to ensure consistency.
# Do NOT set HF_HOME at the workflow level - it previously pointed at github.workspace
# which conflicts with the ~/.cache path used by actions/cache.

# Python versions to test - update all three jobs when changing versions
# Current: ["3.12"]
# For compatibility testing: ["3.11", "3.12", "3.13"]
# Or when you are satisfied that e.g. linting is only on one version, you can accept the differences.

jobs:
  # Setup job validates that dependencies install correctly and warms the UV cache.
  # Python 3.12 is pinned to avoid pypika build failures with Python 3.14
  # See tests/ci/test_github_actions_setup.py for validation tests
  # See docs/technical/CI_SETUP.md for detailed documentation
  # Private repo runners have ~14GB disk; free-disk-space avoids "No space left" errors
  setup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"] # See workflow-level comment for version management
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Free up disk space (private repo runner limit ~14GB)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Set up Python and uv with caching
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
      - name: Log disk usage
        if: always()
        run: |
          echo "=== Disk usage after setup ==="
          df -h /
          echo "=== Large directories ==="
          du -sh ~/.cache/uv ~/.local/share/uv 2>/dev/null || true

  # Linting job - runs independently
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"] # See workflow-level comment for version management
    needs: setup
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Free up disk space (private repo runner limit ~14GB)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Set up Python and uv with caching
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
      - name: Lint with ruff (auto-fix and verify)
        run: |
          # Run ruff check with --fix to automatically fix issues
          echo "Running ruff check --fix..."
          uv run ruff check --fix . || true

          # Run ruff format to automatically format code
          echo "Running ruff format..."
          uv run ruff format . || true

          # Verify no remaining linting issues after auto-fix
          echo "Verifying no remaining linting issues..."
          uv run ruff check .
          uv run ruff format --check .

  # Model download job - downloads lightweight CI models and warms the HF cache
  # Private repos have ~14GB disk; use free-disk-space to avoid "No space left" errors
  model-download:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"] # See workflow-level comment for version management
    needs: setup
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Free up disk space (private repo runner limit ~14GB)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Set up Python and uv with caching
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
      - name: Cache HuggingFace models
        uses: actions/cache@v5
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-ci-${{ hashFiles('scripts/setup_embedding_models.py') }}
          restore-keys: |
            ${{ runner.os }}-huggingface-ci-
      - name: Pre-download embedding models (CI mode)
        run: |
          export HF_HOME=$HOME/.cache/huggingface
          export TRANSFORMERS_CACHE=$HOME/.cache/huggingface/hub
          export SENTENCE_TRANSFORMERS_HOME=$HOME/.cache/huggingface/sentence_transformers
          uv run python scripts/setup_embedding_models.py --ci
      - name: Log disk usage
        if: always()
        run: |
          echo "=== Disk usage after model download ==="
          df -h /
          echo "=== HuggingFace cache size ==="
          du -sh ~/.cache/huggingface 2>/dev/null || echo "No HF cache"
          echo "=== UV cache size ==="
          du -sh ~/.cache/uv ~/.local/share/uv 2>/dev/null || true

  # Unit test job - fast, always run
  test-unit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"] # See workflow-level comment for version management
    needs: [setup, model-download]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Free up disk space (private repo runner limit ~14GB)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Set up Python and uv with caching
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
      - name: Cache HuggingFace models
        uses: actions/cache@v5
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-ci-${{ hashFiles('scripts/setup_embedding_models.py') }}
          restore-keys: |
            ${{ runner.os }}-huggingface-ci-
      - name: Cache pytest cache
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: ${{ runner.os }}-pytest-${{ hashFiles('**/test_*.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pytest-${{ hashFiles('**/test_*.py') }}-
            ${{ runner.os }}-pytest-
      - name: Run unit tests with coverage
        env:
          # Mitigate PyTorch "Illegal instruction" on older GitHub runner CPUs (see docs/technical/CI_TROUBLESHOOTING.md)
          OMP_NUM_THREADS: "1"
          OPENBLAS_NUM_THREADS: "1"
        run: |
          export HF_HOME=$HOME/.cache/huggingface
          export TRANSFORMERS_CACHE=$HOME/.cache/huggingface/hub
          export SENTENCE_TRANSFORMERS_HOME=$HOME/.cache/huggingface/sentence_transformers
          # Sequential (no -n) for reliable coverage and to avoid parallel race conditions; use -n auto locally for speed
          TRANSFORMERS_OFFLINE=1 HF_DATASETS_OFFLINE=1 uv run pytest -m "not internet and not slow and not ollama and not docker and not guardrails_ci_skip and not ci_skip" --junitxml=test-results-unit.xml --cov=src/backend --cov-report=xml --cov-report=term-missing
      - name: Upload coverage reports
        uses: actions/upload-artifact@v6
        with:
          name: coverage-reports
          path: |
            coverage.xml
            test-results-unit.xml
      - name: Add coverage to job summary
        if: always() && (success() || failure())
        run: |
          if [ -f coverage.xml ]; then
            pct=$(python3 -c "import xml.etree.ElementTree as ET; r=ET.parse('coverage.xml').getroot(); print(f\"{100*float(r.attrib.get('line-rate',0)):.1f}\")")
            {
              echo "## Unit Test Coverage"
              echo ""
              echo "**Coverage:** ${pct}%"
            } >> $GITHUB_STEP_SUMMARY
          fi

  # Performance test job - conditional execution
  test-performance:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"] # See workflow-level comment for version management
    needs: [setup, model-download]
    if: github.event_name == 'pull_request' || contains(github.ref, 'main')
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Free up disk space (private repo runner limit ~14GB)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Set up Python and uv with caching
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
      - name: Cache HuggingFace models
        uses: actions/cache@v5
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-ci-${{ hashFiles('scripts/setup_embedding_models.py') }}
          restore-keys: |
            ${{ runner.os }}-huggingface-ci-
      - name: Cache pytest cache
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: ${{ runner.os }}-pytest-${{ hashFiles('**/test_*.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pytest-${{ hashFiles('**/test_*.py') }}-
            ${{ runner.os }}-pytest-
      - name: Run performance tests
        run: |
          export HF_HOME=$HOME/.cache/huggingface
          export TRANSFORMERS_CACHE=$HOME/.cache/huggingface/hub
          export SENTENCE_TRANSFORMERS_HOME=$HOME/.cache/huggingface/sentence_transformers
          # Run slow tests only (performance-related); sequential for CI reliability
          TRANSFORMERS_OFFLINE=1 HF_DATASETS_OFFLINE=1 uv run pytest -m "slow and not internet and not ollama and not docker and not ci_skip" --junitxml=test-results-performance.xml
      - name: Upload performance test results
        uses: actions/upload-artifact@v6
        with:
          name: performance-test-results
          path: test-results-performance.xml

  # Integration test job - conditional execution
  test-integration:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"] # See workflow-level comment for version management
    needs: [setup, model-download]
    if: github.event_name == 'pull_request' || contains(github.ref, 'main')
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Free up disk space (private repo runner limit ~14GB)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Set up Python and uv with caching
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
      - name: Cache HuggingFace models
        uses: actions/cache@v5
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-ci-${{ hashFiles('scripts/setup_embedding_models.py') }}
          restore-keys: |
            ${{ runner.os }}-huggingface-ci-
      - name: Cache pytest cache
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: ${{ runner.os }}-pytest-${{ hashFiles('**/test_*.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pytest-${{ hashFiles('**/test_*.py') }}-
            ${{ runner.os }}-pytest-
      - name: Run integration tests
        run: |
          export HF_HOME=$HOME/.cache/huggingface
          export TRANSFORMERS_CACHE=$HOME/.cache/huggingface/hub
          export SENTENCE_TRANSFORMERS_HOME=$HOME/.cache/huggingface/sentence_transformers
          # Run integration tests (internet dependent); sequential for CI reliability
          uv run pytest -m "internet and not ollama and not docker and not ci_skip" --junitxml=test-results-integration.xml
      - name: Upload integration test results
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-results
          path: test-results-integration.xml

  # Security scanning job - runs in parallel with tests
  security:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"] # See workflow-level comment for version management
    needs: setup
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Free up disk space (private repo runner limit ~14GB)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Set up Python and uv with caching
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
      - name: Run security scan with bandit
        run: |
          # Run bandit security linter (non-blocking)
          uv run bandit -r src/ -f json -o bandit-report.json || true
          uv run bandit -r src/ -f txt || true
      - name: Run dependency vulnerability check with safety
        run: |
          # Run safety check for known vulnerabilities (non-blocking)
          uv run safety check --json --output safety-report.json || true
          uv run safety check || true
      - name: Upload security reports
        uses: actions/upload-artifact@v6
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # Coverage comment job - posts coverage report on PRs
  # Replaces the standalone coverage-report.yml workflow
  coverage-comment:
    runs-on: ubuntu-latest
    needs: [test-unit]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Download coverage artifact
        uses: actions/download-artifact@v7
        with:
          name: coverage-reports

      - name: Extract coverage percentage
        id: coverage
        run: |
          # Use Python for robust extraction and comment generation (avoids bc/shell quirks)
          python3 << 'PYEOF'
          import os
          import xml.etree.ElementTree as ET

          coverage_file = "coverage.xml"
          if not os.path.isfile(coverage_file):
              with open("coverage_comment.md", "w") as f:
                  f.write("## Code Coverage Report\n\n")
                  f.write("Coverage file not found in artifact.\n")
              raise SystemExit(0)

          try:
              tree = ET.parse(coverage_file)
              root = tree.getroot()
              rate = float(root.attrib.get("line-rate", 0))
              pct = rate * 100

              with open("coverage_comment.md", "w") as f:
                  f.write("## Code Coverage Report\n\n")
                  f.write(f"**Total Coverage:** {pct:.1f}%\n\n")
                  if pct >= 80:
                      f.write("Excellent coverage! (>=80%)\n\n")
                  elif pct >= 60:
                      f.write("Moderate coverage (60-80%)\n\n")
                  else:
                      f.write("Low coverage (<60%)\n\n")
                  f.write("_Coverage report generated from unit tests_\n")

              out_path = os.environ.get("GITHUB_OUTPUT")
              if out_path:
                  with open(out_path, "a") as f:
                      f.write(f"percentage={pct:.1f}\n")
              print(f"Coverage: {pct:.1f}%")
          except Exception as e:
              with open("coverage_comment.md", "w") as f:
                  f.write("## Code Coverage Report\n\n")
                  f.write(f"Error extracting coverage: {e}\n")
              exit(0)  # Don't fail step - still allow PR comment
          PYEOF

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const coverage_comment = fs.readFileSync('coverage_comment.md', 'utf8');

            const pr_number = context.payload.pull_request.number;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Code Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: coverage_comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: coverage_comment
              });
            }

  # CI Summary job - aggregates all results
  ci-summary:
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-performance, test-integration, security, coverage-comment]
    if: always() # Run even if some jobs fail
    steps:
      - name: Generate CI Summary
        run: |
          echo "# CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test-unit.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.test-performance.result == 'success' && 'Passed' || needs.test-performance.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.test-integration.result == 'success' && 'Passed' || needs.test-integration.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts Available" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Reports**: Download from unit test job" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Results**: JUnit XML files for all test types" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Reports**: Bandit and Safety vulnerability scans" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "- Fix linting issues before merging" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.test-unit.result }}" != "success" ]; then
            echo "- Fix unit test failures" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.test-performance.result }}" == "failure" ]; then
            echo "- Review performance test results" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.test-integration.result }}" == "failure" ]; then
            echo "- Review integration test results" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.security.result }}" == "failure" ]; then
            echo "- Review security scan results" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.test-unit.result }}" == "success" ]; then
            echo "- All critical checks passed - ready for review!" >> $GITHUB_STEP_SUMMARY
          fi
